@using Application.Contracts
@model IEnumerable<Application.DTOs.MessageDto>
@inject ICurrentUserService CurrentUser

@foreach (var message in Model)
{
    if (message.IsSystemMessage)
    {
        <div class="text-muted fst-italic small m-2" style="color: #6c757d">
            <span class="ms-2">@message.CreatedAt.ToString("g")</span>
            @message.Content
        </div>
        continue;
    }
    <div class="d-flex mb-3 p-2 border rounded" style="max-width: 600px;" id="message-@message.Id">
        <a asp-page="/Account/Profile" asp-route-identifier="@message.AuthorUsername" class="d-flex text-decoration-none user-profile-link" style="color: inherit">
            <img src="@Url.Content("~/" + message.AuthorAvatarPath)"
                 class="rounded-circle me-2"
                 style="width: 40px; height: 40px; object-fit: cover;" />
        </a>

        <div class="flex-grow-1">
            <div class="d-flex align-items-center justify-content-between mb-1">
                <a asp-page="/Account/Profile" asp-route-identifier="@message.AuthorUsername" class="d-flex align-items-center text-decoration-none user-profile-link" style="color: inherit">
                    <span class="fw-semibold me-2">@message.AuthorUsername</span>
                </a>
                <small class="text-muted">@message.CreatedAt.ToString("g")</small>

                <!-- Three Dots Dropdown -->
                <div class="dropdown ms-auto">
                    <button class="btn btn-link p-0 text-muted text-decoration-none fs-5 ms-1" type="button" id="messageOptionsDropdown-@message.Id"
                            data-bs-toggle="dropdown" aria-expanded="false">
                        <i class="bi bi-three-dots"></i>
                    </button>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm" aria-labelledby="messageOptionsDropdown-@message.Id">
                        <auth-only>
                            @if (CurrentUser.Username == message.AuthorUsername)
                            {
                                <li>
                                    <button type="button" class="dropdown-item text-danger" onclick="showMessageDeleteModal('@message.ConversationID', '@message.Id')">
                                        Delete message
                                    </button>
                                </li>
                            }
                        </auth-only>
                        <li>
                            <button type="button" class="dropdown-item" onclick="navigator.clipboard.writeText('@message.Content')">
                                Copy message
                            </button>
                        </li>
                    </ul>
                </div>
            </div>
            
            <div class="bg-light rounded p-2">
                @message.Content
            </div>
        </div>
    </div>
}

<script src="~/js/defaultSrcImage.js"></script>

<auth-only>
    <script>
      function showMessageDeleteModal(conversationId, messageId) {
        document.getElementById('deleteMessageConversationId').value = conversationId;
        document.getElementById('deleteMessageId').value = messageId;
        var modal = new bootstrap.Modal(document.getElementById('deleteMessageModal'));
        modal.show();
      }
    </script>
</auth-only>